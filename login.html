<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Inicio de Sesión – Multi Inversiones</title>
  <link rel="stylesheet" href="styles.css"/>
  <link rel="icon" href="assets/logo_multinversiones.png" type="image/png"/>
  <!-- (Tus estilos aquí…) -->
</head>
<body>
  <div class="login-card">
    <!-- …tu formulario… -->
    <form id="login-form">…</form>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-firestore.js";
    import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/9.20.0/firebase-messaging.js";

    // 1) Config & init
    const firebaseConfig = { /* tu config */ };
    const app       = initializeApp(firebaseConfig);
    const auth      = getAuth(app);
    const db        = getFirestore(app);
    const messaging = getMessaging(app);

    // 2) DOM refs
    const form   = document.getElementById('login-form');
    const btn    = document.getElementById('btn-login');
    const errMsg = document.getElementById('error-message');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      errMsg.textContent = '';
      btn.disabled   = true;
      btn.textContent = 'Cargando…';

      const email    = form.email.value.trim();
      const password = form.password.value.trim();

      try {
        // Autenticación
        const { user } = await signInWithEmailAndPassword(auth, email, password);
        const uid = user.uid;

        // ------------- Aquí cambia -------------
        // 3) Leer rol de Firestore con getDoc/doc
        const userSnap = await getDoc(doc(db, 'users', uid));
        if (!userSnap.exists()) throw new Error('No se encontró usuario.');
        const { rol } = userSnap.data();

        // 4) Actualizar token FCM si hay
        try {
          const token = await getToken(messaging);
          if (token) {
            await updateDoc(doc(db, 'users', uid), { notificationToken: token });
          }
        } catch (_) {}

        // 5) Redirigir según rol
        const rutas = {
          user:             'usuario.html',
          analista_credito: 'analista_credito_panel.html',
          caja:             'caja.html',
          asesorCobros:     'asesor_cobros.html',
          admin:            'admin_panel.html',
          ejecutivo:        'ejecutivo_panel.html',
          gerente:          'gerente_panel.html'
        };
        window.location.href = rutas[rol] || 'login.html';

      } catch (err) {
        errMsg.textContent = err.message || 'Error al iniciar sesión.';
      } finally {
        btn.disabled   = false;
        btn.textContent = 'Iniciar Sesión';
      }
    });
  </script>
</body>
</html>

